'use strict';

Object.defineProperty(exports, '__esModule', {
  value: true
});
exports.runCLI = exports.run = undefined;

let run = (exports.run = (() => {
  var _ref = _asyncToGenerator(function*(maybeArgv, project) {
    try {
      const argv = buildArgv(maybeArgv, project);

      if (argv.init) {
        yield (0, (_init || _load_init()).default)();
        return;
      }

      const projects = getProjectListFromCLIArgs(argv, project);

      var _ref2 = yield runCLI(argv, projects);

      const results = _ref2.results,
        globalConfig = _ref2.globalConfig;

      readResultsAndExit(results, globalConfig);
    } catch (error) {
      (0, (_jestUtil || _load_jestUtil()).clearLine)(process.stderr);
      (0, (_jestUtil || _load_jestUtil()).clearLine)(process.stdout);
      console.error((_chalk || _load_chalk()).default.red(error.stack));
      (0, (_exit || _load_exit()).default)(1);
      throw error;
    }
  });

  return function run(_x, _x2) {
    return _ref.apply(this, arguments);
  };
})());

var _jestUtil;

function _load_jestUtil() {
  return (_jestUtil = require('jest-util'));
}

var _jestValidate;

function _load_jestValidate() {
  return (_jestValidate = require('jest-validate'));
}

var _jestConfig;

function _load_jestConfig() {
  return (_jestConfig = require('jest-config'));
}

var _args;

function _load_args() {
  return (_args = _interopRequireWildcard(require('./args')));
}

var _chalk;

function _load_chalk() {
  return (_chalk = _interopRequireDefault(require('chalk')));
}

var _create_context;

function _load_create_context() {
  return (_create_context = _interopRequireDefault(
    require('../lib/create_context')
  ));
}

var _exit;

function _load_exit() {
  return (_exit = _interopRequireDefault(require('exit')));
}

var _getChangedFilesPromise;

function _load_getChangedFilesPromise() {
  return (_getChangedFilesPromise = _interopRequireDefault(
    require('../getChangedFilesPromise')
  ));
}

var _collectHandles;

function _load_collectHandles() {
  return (_collectHandles = require('../collectHandles'));
}

var _fs;

function _load_fs() {
  return (_fs = _interopRequireDefault(require('fs')));
}

var _handle_deprecation_warnings;

function _load_handle_deprecation_warnings() {
  return (_handle_deprecation_warnings = _interopRequireDefault(
    require('../lib/handle_deprecation_warnings')
  ));
}

var _log_debug_messages;

function _load_log_debug_messages() {
  return (_log_debug_messages = _interopRequireDefault(
    require('../lib/log_debug_messages')
  ));
}

var _preRunMessage;

function _load_preRunMessage() {
  return (_preRunMessage = require('../preRunMessage'));
}

var _runJest;

function _load_runJest() {
  return (_runJest = _interopRequireDefault(require('../runJest')));
}

var _jestRuntime;

function _load_jestRuntime() {
  return (_jestRuntime = _interopRequireDefault(require('jest-runtime')));
}

var _TestWatcher;

function _load_TestWatcher() {
  return (_TestWatcher = _interopRequireDefault(require('../TestWatcher')));
}

var _watch;

function _load_watch() {
  return (_watch = _interopRequireDefault(require('../watch')));
}

var _pluralize;

function _load_pluralize() {
  return (_pluralize = _interopRequireDefault(require('../pluralize')));
}

var _yargs;

function _load_yargs() {
  return (_yargs = _interopRequireDefault(require('yargs')));
}

var _rimraf;

function _load_rimraf() {
  return (_rimraf = _interopRequireDefault(require('rimraf')));
}

var _realpathNative;

function _load_realpathNative() {
  return (_realpathNative = require('realpath-native'));
}

var _init;

function _load_init() {
  return (_init = _interopRequireDefault(require('../lib/init')));
}

function _interopRequireDefault(obj) {
  return obj && obj.__esModule ? obj : {default: obj};
}

function _interopRequireWildcard(obj) {
  if (obj && obj.__esModule) {
    return obj;
  } else {
    var newObj = {};
    if (obj != null) {
      for (var key in obj) {
        if (Object.prototype.hasOwnProperty.call(obj, key))
          newObj[key] = obj[key];
      }
    }
    newObj.default = obj;
    return newObj;
  }
}

function _asyncToGenerator(fn) {
  return function() {
    var gen = fn.apply(this, arguments);
    return new Promise(function(resolve, reject) {
      function step(key, arg) {
        try {
          var info = gen[key](arg);
          var value = info.value;
        } catch (error) {
          reject(error);
          return;
        }
        if (info.done) {
          resolve(value);
        } else {
          return Promise.resolve(value).then(
            function(value) {
              step('next', value);
            },
            function(err) {
              step('throw', err);
            }
          );
        }
      }
      return step('next');
    });
  };
}
/**
 * Copyright (c) 2014-present, Facebook, Inc. All rights reserved.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 *
 *
 */

const runCLI = (exports.runCLI = (() => {
  var _ref3 = _asyncToGenerator(function*(argv, projects) {
    const realFs = require('fs');
    const fs = require('graceful-fs');
    fs.gracefulify(realFs);

    let results;

    // If we output a JSON object, we can't write anything to stdout, since
    // it'll break the JSON structure and it won't be valid.
    const outputStream =
      argv.json || argv.useStderr ? process.stderr : 